USE [TN_CSDLPT]
GO
/****** Object:  StoredProcedure [dbo].[SP_XEM_DANH_SACH_DANG_KY_THI]    Script Date: 12/28/2019 5:03:01 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- =============================================
-- Author:		<Author,,Name>
-- Create date: <Create Date,,>
-- Description:	<Description,,>
-- =============================================
ALTER PROCEDURE [dbo].[SP_XEM_DANH_SACH_DANG_KY_THI]
	-- Add the parameters for the stored procedure here
	@NGAYBD datetime,
	@NGAYKT datetime

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;

    -- Insert statements for procedure here
	 SELECT STT=ROW_NUMBER() OVER (ORDER BY (SELECT NULL)),
	 COSO= '1', --(SELECT TENCS FROM COSO WHERE COSO.MACS= (SELECT MACS FROM LOP WHERE MALOP=GIAOVIEN_DANGKY.MALOP)),
	 TENLOP= (SELECT TENLOP FROM LINK1.TN_CSDLPT.dbo.LOP WHERE LOP.MALOP= GIAOVIEN_DANGKY.MALOP ),
	 TENMH=(SELECT TENMH FROM LINK1.TN_CSDLPT.dbo.MONHOC WHERE MONHOC.MAMH= GIAOVIEN_DANGKY.MAMH),
	 GVDK= (SELECT HO+TEN FROM LINK1.TN_CSDLPT.dbo.GIAOVIEN WHERE GIAOVIEN.MAGV = GIAOVIEN_DANGKY.MAGV)
	 ,SOCAUTHI,
	 NGAYTHI ,
	 DATHI=  (
			CASE WHEN EXISTS (SELECT * FROM LINK1.TN_CSDLPT.dbo.BANGDIEM WHERE BANGDIEM.MAMH =MAMH AND BANGDIEM.MASV IN (SELECT MASV FROM LINK1.TN_CSDLPT.dbo.SINHVIEN WHERE SINHVIEN.MALOP= GIAOVIEN_DANGKY.MALOP))
			THEN 'X'
			ELSE ''
			END  
		),
			
	 GHICHU='' FROM LINK1.TN_CSDLPT.dbo.GIAOVIEN_DANGKY
	 WHERE NGAYTHI IN (SELECT NGAYTHI FROM LINK1.TN_CSDLPT.dbo.GIAOVIEN_DANGKY WHERE GIAOVIEN_DANGKY.NGAYTHI BETWEEN @NGAYBD and @NGAYKT )
	 UNION ALL 

	 SELECT STT=ROW_NUMBER() OVER (ORDER BY (SELECT NULL)),
	 COSO= '2', --(SELECT TENCS FROM COSO WHERE COSO.MACS= (SELECT MACS FROM LOP WHERE MALOP=GIAOVIEN_DANGKY.MALOP)),
	 TENLOP= (SELECT TENLOP FROM LINK2.TN_CSDLPT.dbo.LOP WHERE LOP.MALOP= GIAOVIEN_DANGKY.MALOP ),
	 TENMH=(SELECT TENMH FROM MONHOC WHERE MONHOC.MAMH= GIAOVIEN_DANGKY.MAMH),
	 GVDK= (SELECT HO+TEN FROM LINK2.TN_CSDLPT.dbo.GIAOVIEN WHERE GIAOVIEN.MAGV = GIAOVIEN_DANGKY.MAGV)
	 ,SOCAUTHI,
	 NGAYTHI ,
	 DATHI=  (
			CASE WHEN EXISTS (SELECT * FROM LINK2.TN_CSDLPT.dbo.BANGDIEM WHERE BANGDIEM.MAMH =MAMH AND BANGDIEM.MASV IN (SELECT MASV FROM LINK2.TN_CSDLPT.dbo.SINHVIEN WHERE SINHVIEN.MALOP= GIAOVIEN_DANGKY.MALOP))
			THEN 'X'
			ELSE ''
			END  
		),
			
	 GHICHU='' FROM LINK2.TN_CSDLPT.dbo.GIAOVIEN_DANGKY
	 WHERE NGAYTHI IN (SELECT NGAYTHI FROM LINK2.TN_CSDLPT.dbo.GIAOVIEN_DANGKY WHERE GIAOVIEN_DANGKY.NGAYTHI BETWEEN @NGAYBD and @NGAYKT )
	 END 